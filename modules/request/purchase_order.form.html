<section>
    VmInclude:__PARTS__/toolbar/back_save.html
	<form id=F__ID>
        <table id=tb__ID style='width:770px'>
            <colgroup>
				<col style='width:300px' />
                <col />
            </colgroup>

            <tr><td colspan=2 class='header__ID'>Purchase Order</td></tr>
			<tr><td>Short Description</td><td data-id=Short_Description></td></tr>
			<tr><td>Manager for Approval</td><td data-id=Manager_for_Approval  data-custom=1></td></tr>
            <tr><td>Supplier Account No (if applicable)</td><td data-id=Supplier_Account_No></td></tr>
			<tr><td>Supplier Name</td><td data-id=Supplier_Name></td></tr>
			<tr><td>Supplier Address</td><td data-id=Supplier_Address></td></tr>
			<tr><td>Supplier Phone</td><td data-id=Supplier_Phone></td></tr>
			<tr><td>Supplier Fax</td><td data-id=Supplier_Fax></td></tr>
			<tr><td colspan=2 class='subheader__ID'>Purchase Order Items</td></tr>
            <tr><td colspan=2>
                <u style='cursor:pointer' id=add_an_item__ID>Add an item</u>
                <table id=grid_item_a__ID></table>
                <table style='width:300px;float:right;border-collapse: collapse;'>
                    <colgroup><col style='width:180px' /><col /></colgroup>
                    <tr><td>GST Amount</td><td data-id='GST_Amount'></td></tr>
                    <tr><td>Total Amount</td><td data-id='Total_Amount'></td></tr>
                </table>
            </td></tr>
        </table>
    </form>
</section>
<script>
    function F__ID(){
        //----------------------------------
        VmInclude:__PARTS__/grid/form.2.js
		VmInclude:__PARTS__/grid/grid_item_a.2.js
        VmInclude:__PARTS__/style/ease-in-out.2.js
        //----------------------------------
		//get manager list;
        var list_managers='';
        var list_sql="select Name=S1,Email=S2,Login_Name=S3 from [TABLE-"+_mlist[_ids.managers].table_id+"]";
        var req={cmd:'query_records',sql:list_sql};
        jQuery.ajaxSetup({async:false});
        $VmAPI.request({data:req,callback:function(res){
            if(res.records.length>0){
                list_managers='';
                for(var i=0;i<res.records.length;i++){
                    if(list_managers!='') list_managers+=','
                    list_managers+=res.records[i].Name+";"+res.records[i].Name+"/"+res.records[i].Email+"/"+res.records[i].Login_Name;
                }
            }
        }});
        jQuery.ajaxSetup({async:true});
        //---------------------------------------------
        $('#D__ID').on('load',function(){
            _init();
            _field_process();
            custom_field_process();

			$('#save__ID').show();
            if(_save_style=='none') $('#save__ID').hide();

            //-------item a part
			if(_records[I].items==undefined || _records[I].items=='') _records[I].items=[];
			_item_a_records=_records[I].items; _item_a_render();
            //-------
        })
        //----------------------------------
        var custom_field_process=function(){
            $('#tb__ID td[data-custom=1]').each(function(){
                var field=$(this).attr('data-id');
                switch(field){
					case 'Manager_for_Approval':
	                    var html="<select style='border:0;width:100%'></select>";
	                    _records[I].vm_custom[field]=true;
	                    $(this).html(html)
	                    $(this).find('select').on('input', function(){
	                        set_value($(this).val(),_records,I,field);
	                    });
	                    $vm.set_dropdown_list_from_text($(this).find('select'),list_managers);
	                    $(this).find('select').val(_records[I][field])
	                    break;
					case "Client":
                        $(this).find("input[name='"+field+"']").val(_records[I].Client);
                        $(this).find("input[name='"+field+"_uid']").val(_records[I].Client_uid);
                    	break;
					case "xxx":
                    	break;
                }
            })
        }
        //----------------------------------
        _before_submit_form=function(){
            return true;
        }
        //----------------------------------


		//----------------------------------
        //item a part
        _item_a_fields="Description,Unit_Price,Quantity,GST,Amount,_Remove";
        //----------------------------------
        $('#add_an_item__ID').on('click',function(){ _item_a_add(); })
        //----------------------------------
        _item_a_cell_render=function(records,I,field,td,set_value,source){
            switch(field){
                case "Amount":
                    records[I].vm_readonly[field]=true;
                    break;
				case "GST":
					td.html('<input type=checkbox />');
					records[I].vm_custom[field]=true;
					if(records[I][field]=="1") td.find('input').prop('checked', true);
					td.find('input').on('click', function(){
					    if($(this).prop("checked") == true)   set_value("1",records,I,field);
					    else                                  set_value("0",records,I,field);
						_item_a_after_change(records,I,field,td,set_value,source);
					});
                    break;
            }
        }
        //----------------------------------
        _item_a_after_change=function(records,I,field,td,set_value,source){
            switch(field){
				case "Unit_Price":
                case "Quantity":
				case "GST":
                    cal();
                    break;
            }
        }
        //----------------------------------
        _item_a_after_remove=function(){
            cal();
        }
        //----------------------------------
        _item_a_before_submit=function(record,dbv){
            return true;
        }
        //----------------------------------
        var cal=function(){
            var total=0,gst=0;
            for(var i=0;i<_item_a_records.length;i++){
                var p=parseFloat(_item_a_records[i].Unit_Price);
                var q=parseFloat(_item_a_records[i].Quantity);
                if(_item_a_records[i].Unit_Price=='') p=0;
                if(_item_a_records[i].Quantity=='') q=0;
                var a=p*q;
				if(_item_a_records[i].GST=='1'){
					gst+=a*0.1;
					a=a*1.1;
				}
                _item_a_records[i].Amount=a.toFixed(2);
                total+=a;
            }
            _records[I].GST_Amount=gst.toFixed(2);
            _records[I].Total_Amount=total.toFixed(2);
			_records[I].Balance=(_records[I].Total_Payment-_records[I].Total_Amount).toFixed(2);
            _field_process();
            _item_a_render();

			_records[I].invoice_items=_item_a_records;
        }
        //----------------------------------
    }
</script>
<style>
    VmInclude:__PARTS__/toolbar/toolbar.css
    VmInclude:__PARTS__/grid/form.css
	VmInclude:__PARTS__/grid/grid_item_a.css
	VmInclude:__PARTS__/grid/grid_item_b.css
</style>
